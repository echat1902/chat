<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>易聊</title>
    <link rel="stylesheet" href="/static/css/amazeui.min.css"/>
    <link rel="stylesheet" href="/static/css/index/main.css"/>
    <link rel="import" href="/static/view/face.html" id="face"/>
    <link rel="stylesheet" type="text/css" href="/static/bootstrap/css/bootstrap.min.css">
    <link rel="stylesheet" type="text/css" href="/static/webuploader/webuploader.css">

    <link rel="stylesheet" type="text/css" href="/static/imagePreview/css/pictureViewer.css"/>
    <link rel="stylesheet" type="text/css" href="/static/css/index/processBar.css"/>
    <link rel="stylesheet" href="/static/layui/css/layui.css">
    <style>
        .send_msg {
            width: 120px;
            height: 120px;
        }

        #add_friend_frame {
            width: 90%;
            height: 80%;
        }

        #input_area {
            width: 80%;
            height: 50px;
            font-size: 14px;
            line-height: 25px;
            margin: 10px;
            border-bottom: solid 1px #E7E7E7;
        }

        #input_area input {
            border: solid 1px #E7E7E7;
            outline: none;
            width: 300px;
            height: 30px;
            border-radius: 5px;
        }

        #one_person {
            height: 80%;
            width: 80%;
            margin: 10px auto auto 50px;
        }

        #one_person img {
            width: 50px;
            height: 50px;
            border: none;
        }

        .uinfo:nth-child(1) {
            float: left;
            width: 60px;
            height: 30%;
        }

        .uinfo:nth-child(2) {
            float: left;
            margin-left: 5px;
            margin-right: 5px;
            width: 55%;
            height: 30%;
        }

        .uinfo:nth-child(3) {
            float: left;
            width: 20%;
            height: 30%;
            margin: auto 1px;
        }

        .uinfo > input {
            width: 60px;
            height: 30px;
            font-size: 14px;
            border: 0px;
            color: #fff;
            line-height: 30px;
            margin: 15px;
            background: #1AAD19;
        }

        .uinfo > input:hover {
            background: #1AAD;
        }

        .obj_list {
            width: 90%;
            height: 80%;
            margin: 10px 10px;
            display: none;
        }

        .new_friend {
            width: 80%;
            height: 75px;
            margin: 5px 5px 5px 50px;
            border-bottom: solid 1px #E7E7E7;
        }

        .new_friend .uinfo:nth-child(1) {
            float: left;
            width: 60px;
            height: 80%;
        }

        .uinfo > img {
            width: 50px;
            height: 50px;
            border: none;
        }
        .file_down:hover{
            cursor: pointer;
        }
    </style>
</head>
<body>
<div class="box">
    <div class="wechat">
        <input type="hidden" id="user_id" value={{ data[0].user_id }}>
        <input type="hidden" id="user_no" value={{ data[0].user_no }}>
        <div class="sidestrip">
            <div class="am-dropdown" data-am-dropdown>
                <!--头像插件-->
                <div class="own_head am-dropdown-toggle"
                     style="background: url(/static/images/head/{{ data[0].pic_name }});background-size: contain;"></div>
                <!-- 点击头像，取消am-dropdown-content的显示，改为显示user_info_show元素块
                <div class="am-dropdown-content">
                    <div class="own_head_top">
                        <div class="own_head_top_text">
                            <p class="own_name">{{ data[0].user_nick_name }}<img src="/static/images/icon/head.png"
                                                                                 alt=""/></p>
                            <p class="own_numb">易号：{{ data[0].user_no }}</p>
                        </div>
                        <img src="/static/images/own_head.jpg" alt=""/>
                    </div>
                    <div class="own_head_bottom">
                        <p><span>地区</span>xx</p>
                        <div class="own_head_bottom_img">
                            <a href=""><img src="/static/images/icon/head_1.png"/></a>
                            <a href=""><img src="/static/images/icon/head_2.png"/></a>
                        </div>
                    </div>
                </div> -->
            </div>
            <!--三图标-->
            <div class="sidestrip_icon">
                <a id="si_1" style="background: url(/static/images/icon/head_2_1.png) no-repeat;"></a>
                <a id="si_2"></a>
                <a id="si_3"></a>
            </div>

            <!--底部扩展键-->
            <div id="doc-dropdown-justify-js">
                <div class="am-dropdown" id="doc-dropdown-js" style="position: initial;">
                    <div class="sidestrip_bc am-dropdown-toggle"></div>
                    <ul class="am-dropdown-content" style="">
                        <li>
                            <a href="#"
                               data-am-modal="{target: '#doc-modal-1', closeViaDimmer: 0, width: 400, height: 225}">意见反馈</a>
                            <div class="am-modal am-modal-no-btn" tabindex="-1" id="doc-modal-1">
                                <div class="am-modal-dialog">
                                    <div class="am-modal-hd">Modal 标题
                                        <a href="javascript: void(0)" class="am-close am-close-spin"
                                           data-am-modal-close>&times;</a>
                                    </div>
                                    <div class="am-modal-bd">
                                        Modal 内容。本 Modal 无法通过遮罩层关闭。
                                    </div>
                                </div>
                            </div>
                        </li>

                        <li><a href="#">备份与恢复</a></li>
                        <li><a href="#">设置</a></li>
                    </ul>
                </div>
            </div>
        </div>

        <!--聊天对象列表-->
        <div class="middle on">
            <div class="wx_search">
                <input type="text" placeholder="搜索"/>
                <button id="add_button">+</button>
            </div>
            <div class="office_text">
                <ul class="user_list">
                    {% for i in data[1] %}
                        <li
                                id={{ i.lid }}
                                        title={{ i.user_nick_name }}{{ i.group_name }}
                                uid={{ i.user_id }}{{ i.group_id }}
                        >
                            <div class="red_circle">1</div>
                            <div class="user_head"><img src=/static/images/head/{{ i.pic_name }}/></div>
                            <div class="user_text">
                                <p class="user_name">
                                    {% if not i.user_nick_name %}
                                        {{ i.group_name }}
                                    {% else %}
                                        {{ i.user_nick_name }}
                                    {% endif %}
                                </p>
                                <p class="user_message">{{ i.content }}</p>
                            </div>
                            <div class="user_time">{{ i.update_time }}</div>
                        </li>
                    {% endfor %}
                </ul>
            </div>
        </div>

        <!--好友列表-->
        <div class="middle">
            <div class="wx_search">
                <input type="text" placeholder="搜索"/>
                <button>+</button>
            </div>
            <div class="office_text">
                <ul class="friends_list">
                    <li>
                        <p>新的朋友</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/1.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">新的朋友</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>公众号</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/2.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">公众号</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>A</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/3.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">彭于晏丶plus</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/4.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">陈依依</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/5.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">毛毛</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>B</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/6.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">苏笑言</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/7.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">往事不再提</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>C</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/8.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">夏继涛</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/9.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">早安无恙</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/10.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">王鹏</p>
                            </div>
                        </div>
                    </li>
                    <li>
                        <p>D</p>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/11.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">涨了潮了</p>
                            </div>
                        </div>
                        <div class="friends_box">
                            <div class="user_head"><img src="/static/images/head/12.jpg"/></div>
                            <div class="friends_text">
                                <p class="user_name">Ktz丶中融资</p>
                            </div>
                        </div>
                    </li>
                </ul>
            </div>
        </div>

        <!--程序列表-->
        <div class="middle">
            <div class="wx_search">
                <input type="text" placeholder="搜索收藏内容"/>
                <button>+</button>
            </div>
            <div class="office_text">
                <ul class="icon_list">
                    <li class="icon_active">
                        <div class="icon"><img src="/static/images/icon/icon.png" alt=""/></div>
                        <span>全部收藏</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon1.png" alt=""/></div>
                        <span>链接</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon2.png" alt=""/></div>
                        <span>相册</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon3.png" alt=""/></div>
                        <span>笔记</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon4.png" alt=""/></div>
                        <span>文件</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon5.png" alt=""/></div>
                        <span>音乐</span>
                    </li>
                    <li>
                        <div class="icon"><img src="/static/images/icon/icon6.png" alt=""/></div>
                        <span>标签</span>
                    </li>
                </ul>
            </div>
        </div>

        <!--聊天窗口-->
        <div class="talk_window">
            <div class="windows_top">
                <div class="windows_top_box">
                    <span class="user_title"></span>
                    <ul class="window_icon">
                        <li><a href=""><img src="/static/images/icon/icon7.png"/></a></li>
                        <li><a href=""><img src="/static/images/icon/icon8.png"/></a></li>
                        <li><a href=""><img src="/static/images/icon/icon9.png"/></a></li>
                        <li><a href="/logout" style="display: block; height: 34px; width: 26px"><img
                                src="/static/images/icon/icon10.png"/></a></li>
                    </ul>
                    <div class="extend" class="am-btn am-btn-success"
                         data-am-offcanvas="{target: '#doc-oc-demo3'}"></div>
                    <!-- 侧边栏内容 -->
                    <div id="doc-oc-demo3" class="am-offcanvas">
                        <div class="am-offcanvas-bar am-offcanvas-bar-flip" style="height: 680px;margin:auto">
                            <div class="am-offcanvas-content">
                                <p><a href="http://music.163.com/#/song?id=385554" target="_blank">网易音乐</a></p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--聊天内容-->
            <div class="windows_body">
                <div class="office_text" style="height: 100%;">
                    <!-- 聊天记录 -->
                    <ul class="content" id="chatbox">

                    </ul>

                </div>
            </div>
            <!-- 好友申请列表 -->
            <div class="obj_list">

            </div>
            <!-- 消息输入框 -->
            <div class="windows_input" id="talkbox">
                <div class="input_icon" style="position:relative">
                    <a id="face_icon" href="javascript:;"></a>
                    <a id="picker" href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <a href="javascript:;"></a>
                    <!-- 表情 -->
                    <script type="text/javascript">
                        document.write(face.import.body.innerHTML)
                    </script>
                </div>
                <div class="input_box">
                    <!--<textarea name="" rows="" cols="" id="input_box"></textarea>-->
                    <div class="message_frame" contentEditable='true'></div>
                    <button id="send">发送（S）</button>
                </div>
            </div>
        </div>
    </div>
</div>
<!-- 添加好友页面 -->
<div id="add_friend_frame">
    <div id="input_area">
        <input id="input_yh" type="text" placeholder="输入用户名或易号"/>
    </div>
    <div id="one_person" style="display: none;">
        <div class="uinfo">
            <img src=""/>
        </div>
        <div class="uinfo">
            <div style="margin: 5px 5px 10px 5px;">姚明</div>
            <div style="margin-left: 5px;">我是xxx</div>
        </div>
        <div class="uinfo">
            <input id='add_friend_button' type="button" value="添加"/>
        </div>
    </div>
</div>
<!-- 用户个人信息页 -->
<style>
    /* 取消添加好友页面的默认显示 */
    #add_friend_frame{
        display: none;
    }
    #user_info_show{
        position: relative;
        display: none;
    }
    #user_info_show .user_head_show{
        width: 100px;
        position: absolute;
        top: 50px;
        left: 20px;
    }
    #user_info_show .user_head_show img{
        width: 100px;
        height: 100px;
    }
    #user_info_show .user_head_show button{
        margin-top: 10px;
        margin-left: 18px;
    }
    #user_info_show form{
        width:400px;
        float: right;
        padding-top: 50px;
        position: relative;
    }
    #user_info_show form input{
        width:300px;
    }
    #user_info_show form button{
        position: absolute;
        right: 100px;
    }
</style>
<div id="user_info_show">
    <div class="user_head_show">
        <img src="/static/images/head/{{ data[0].pic_name }}" alt="头像">
        <button type="button" class="layui-btn" id="user_head_upload">上传</button>
    </div>
    <form class="layui-form layui-form-pane" method="post">
        <div class="layui-form-item">
            <label class="layui-form-item">用户名</label>
            <div class="layui-form-block">
                <input type="text" name="user_nick_name" lay-verify="required" value="{{ data[0].user_nick_name }}" autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-item">手机号</label>
            <div class="layui-form-block">
                <input type="text" name="user_tel" lay-verify="phone"
                    {% if data[0].user_tel %}
                       value="{{ data[0].user_tel }}"
                    {% else %}
                       placeholder="暂未填写"
                    {% endif %}
                    autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <label class="layui-form-item">邮箱</label>
            <div class="layui-form-block">
                <input type="email" name="user_email" lay-verify="email"
                    {% if data[0].user_email %}
                       value="{{ data[0].user_email }}"
                    {% else %}
                       placeholder="暂未填写"
                    {% endif %}
                    autocomplete="off" class="layui-input">
            </div>
        </div>
        <div class="layui-form-item">
            <div class="layui-input-block">
                <button class="layui-btn" lay-submit lay-filter="user_info_form">保存</button>
            </div>
        </div>
    </form>
</div>
<script type="text/javascript" src="/static/js/jquery-1.12.4.min.js"></script>
<script type="text/javascript" src="/static/js/amazeui.min.js"></script>
<script type="text/javascript" src="/static/js/zUI.js"></script>
<script type="text/javascript" src="/static/js/index/wechat.js"></script>
<script src="/static/js/layer/layer.js"></script>
<script src="/static/bootstrap/js/bootstrap.min.js"></script>
<script src="/static/webuploader/webuploader.min.js"></script>
<script src="/static/imagePreview/js/pictureViewer.js"></script>
<script type="text/javascript" src="//cdn.bootcss.com/socket.io/1.5.1/socket.io.min.js"></script>
<script src="/static/layui/layui.js"></script>
<script type="text/javascript">
    var now_time = (new Date()).getTime();
    pic_addr = '/static/images/head/';
     //等待服务器推送消息
    var namespace = '/flasksocketio';
    var socket = io.connect(location.protocol + '//' + document.domain + ':' + location.port + namespace);
    //让滚动条到最底部
    function scroll_to_bottom(){
        chat = $('#chatbox');
        scrollTop = chat[0].scrollHeight;
        chat.parent().scrollTop(scrollTop);
    }
    //点击添加好友按钮
    $('#add_button').click(function () {
        index1 = layer.open({
            type: 1,
            area: ['580px', '440px'],
            title: '添加好友',
            btn: ['取消'],
            shadeClose: false,
            content: $('#add_friend_frame')
        })
    });
    //根据用户名或易号或群号查询信息
    $(document).on('blur', '#input_yh', function () {
        v = $(this).val();
        $.get('/getUserInfo?value=' + v, '', function (data) {
            if (data.status == 1) {
                $('#one_person').css('display', 'block');
                uf = $('#one_person').children('div');
                uf.eq(0).children('img').attr('src', pic_addr + data.data.pic_name);
                if (data.data.user_id) {
                    $('#one_person').attr('obj_id', data.data.user_id);
                    $('#one_person').attr('obj_type', 1);
                    uf.eq(1).children('div').eq(0).html(data.data.user_nick_name);
                    uf.eq(1).children('div').eq(1).html('易号：' + data.data.user_no);
                } else {
                    $('#one_person').attr('obj_type', 2);
                    $('#one_person').attr('obj_id', data.data.group_no);
                    uf.eq(1).children('div').eq(0).html(data.data.group_name);
                    uf.eq(1).children('div').eq(1).html('易号：' + data.data.group_no);
                }

            } else {
                layer.msg(data.msg);
                $('#one_person').css('display', 'none');
            }
        }, 'json')
    });

    //关闭右边聊天框
    function close_talk() {
        $('.windows_body,.windows_input').css('display', 'none')
        $('.user_title').html('')
    }

    //打开右边聊天框
    function open_talk() {
        $('.windows_body,.windows_input').css('display', 'block')
    }

    //新的朋友列表
    $('.friends_box:eq(0)').click(function () {
        close_talk();
        $('.user_title').html('新的朋友');
        $('.friends_box').removeClass('user_active');
        $(this).addClass('user_active');
        $('.obj_list').css('display', 'block').html('');
        var user_id = $('#user_id').val()
        $.get('/friRequest?user_id=' + user_id, '', function (data) {
            console.log(data)
            $.each(data.data, function (k, v) {
                str = '<div class="new_friend" id="' + v.pri_id + '">\n' +
                    '                    <div class="uinfo">\n' +
                    '                        <img src="' + pic_addr + v.pic_name + '"/>\n' +
                    '                    </div>\n' +
                    '                    <div class="uinfo">\n' +
                    '                        <div style="margin: 5px 5px 10px 5px;">' + v.user_nick_name + '</div>\n' +
                    '                        <div style="margin-left: 5px;">' + v.remark + '</div>\n' +
                    '                    </div>\n' +
                    '                    <div class="uinfo">\n' +
                    '                        <input type="button" class="recv" value="接受"/>\n' +
                    '                    </div>\n' +
                    '                </div>';
                $('.obj_list').append(str)
            })
        }, 'json')
    });

    //点击用户头像，弹出个人信息页
    $(".own_head").click(function () {
       index2=layer.open({
            type: 1,
            area: ['580px', '440px'],
            title: '个人信息',
            content: $('#user_info_show')
       })
    });
    //加载layui入口文件(包含头像上传，用户个人信息表单提交功能)
    layui.config({
        base: '/static/js/'
    }).use('layui_index');
    //如果个人信息页 手机号或邮箱为空，则跳过相应的前端验证
    $("#user_info_show form button").click(function () {
        var input_tel = $("[name=user_tel]");
        var input_email = $("[name=user_email]");

        if (input_tel.val() == ''){
            input_tel.removeAttr('lay-verify');
        }
        if (input_email.val() == ''){
            input_email.removeAttr('lay-verify');
        }
    });

    //三图标
    window.onload = function () {
        //生成聊天信息
        function create_chart(self, content) {
            pic_name = eval("'" + content["pic_name"] + "'"); // "我是unicode编码"
            user_nick_name = eval("'" + content["user_nick_name"] + "'"); // "我是unicode编码"
            send_msg = eval("'" + content["send_msg"] + "'"); // "我是unicode编码"
            msg_type = content['msg_type'] ? content['msg_type'] : 1;
            if (msg_type == 1) {
                var info = '<li class=' + self + '><img src="/static/images/head/' + pic_name + '" title="' + user_nick_name + '"><span>' + send_msg + '</span></li>'
                $('#chatbox').append(info)
            } else if (msg_type == 2) {
                var info = '<li class=' + self + '><img src="/static/images/head/' + pic_name + '" title="' + user_nick_name + '"><img src="' + send_msg + '" /></li>'
                $('#chatbox').append(info)
            }else{
                var img_addr = pic_addr + pic_name;
                var file_name = content['file_name'];
                var str_file_ext = content['file_ext'];
                var filesize = get_file_size(content['filesize']);
                var file_path = content['file_path'] + file_name;
                var content_type = 3;
                file_show('other', img_addr, file_name, str_file_ext, 2, filesize,file_path, content_type);
            }

        }

        var msg_nums = [];
        var boo = true;

        socket.on('server_response', function (res) {
            res = JSON.parse(res);
            console.log(res)
            lid = res.lid;
            num_area = $('#' + lid).children('div').eq(0);
            if(res.msg_type==1){
                left_title = res.send_msg
            }else if(res.msg_type==2){
                left_title = "[图片]"
            }else{
                left_title = "[文件]"
            }
            $('#' + lid).children('div').eq(2).children('p').eq(1).html(left_title);
            if ($('#' + lid).hasClass('user_active')) {
                msg_nums[lid] = 0;
                num_area.css('display', 'none');
                if (res.user_nick_name != "{{data[0].user_nick_name}}") {
                    create_chart('other', res);
                    send_msg.value = '';
                    scroll_to_bottom()
                }
            } else {
                num_area.css('display', 'block');
                if (msg_nums[lid]) {
                    msg_nums[lid] = msg_nums[lid] + 1
                } else {
                    msg_nums[lid] = 1;
                }
                num_area.html(msg_nums[lid]);
            }

        });
    //将某个对象加入房间
        function add_room(lid){
            socket.emit('join room', {'lid': lid});
        }
        // 将所有聊天对象都加入房间
        $('.user_list li').each(function (i) {
            lid = $(this).attr('id');
            //加入房间
            socket.emit('join room', {'lid': lid});
        });

        //点击添加好友/群
        $(document).on('click', '#add_friend_button', function () {
            sub_id = $('#one_person').attr('obj_id');
            pri_id = $('#user_id').val();
            obj_type = $('#one_person').attr('obj_type');
            $.post('/addFriend', {'sub_id': sub_id, 'pri_id': pri_id, 'obj_type': obj_type}, function (data) {
                if (data.status == 1) {
                    layer.msg(data.msg, {time: 2000}, function () {
                        layer.close(index1)
                        if( $.isEmptyObject(data.data) != true){  //加群
                            str = '<li\n' +
                            '         id=' + data.data.lid + '\n' +
                            '         uid=' + data.data.group_id + '\n' +
                            '         title=' + data.data.group_name + '\n' +
                            '         >\n' +
                            '           <div class="red_circle">1</div>\n' +
                            '           <div class="user_head"><img src=/static/images/head/' + data.data.pic_name + ' /></div>\n' +
                            '           <div class="user_text">\n' +
                            '               <p class="user_name">\n' +
                            '                   ' + data.data.group_name + '\n' +
                            '               </p>\n' +
                            '               <p class="user_message">' + data.data.content + '</p>\n' +
                            '           </div>\n' +
                            '           <div class="user_time">' + data.data.update_time + '</div>\n' +
                            '      </li>';
                            $('.user_list').append(str)
                             //加入到这个房间
                            //add_room(data.data.lid)
                            lid = data.data.lid
                            socket.emit('join room', {'lid': lid});
                            content={
                                'lid':data.data.lid,
                                'send_user_id':pri_id,
                                'send_msg':'大家好,我是'+"{{data[0].user_nick_name}}",
                                'msg_type':1
                            };
                            socket.emit('imessage', content);

                        }
                    });
                } else {
                    layer.msg(data.msg)
                }
            }, 'json')
    });
        //接受好友
        $(document).on('click', '.recv', function () {
            obj = $(this)
            var pri_id = obj.parent().parent().attr('id')
            var sub_id = $('#user_id').val();
            $.post('/friRequest', {pri_id: pri_id, sub_id: sub_id}, function (data) {
                console.log(data);
                if (data.status == 1) {
                    layer.msg(data.msg, {time: 2000}, function () {
                        obj.parent().parent().remove();
                        str = '<li\n' +
                            '         id=' + data.data.lid + '\n' +
                            '         uid=' + data.data.pri_id + '\n' +
                            '         title=' + data.data.user_nick_name + '\n' +
                            '         >\n' +
                            '           <div class="red_circle">1</div>\n' +
                            '           <div class="user_head"><img src=/static/images/head/' + data.data.pic_name + ' /></div>\n' +
                            '           <div class="user_text">\n' +
                            '               <p class="user_name">\n' +
                            '                   ' + data.data.user_nick_name + '\n' +
                            '               </p>\n' +
                            '               <p class="user_message">' + data.data.content + '</p>\n' +
                            '           </div>\n' +
                            '           <div class="user_time">' + data.data.update_time + '</div>\n' +
                            '      </li>';
                        $('.user_list').append(str)
                        //加入到这个房间
                        add_room(data.data.lid)
                        content={
                            'lid':data.data.lid,
                            'send_user_id':pri_id,
                            'send_msg':'你好,我是'+data.data.user_nick_name,
                            'msg_type':1
                        };
                        socket.emit('imessage', content);

                    })
                } else {
                    layer.msg(data.msg)
                }

            }, 'json')
        })
        //获取聊天记录
        $(document).on('click', '.user_list li', function () {
            open_talk();
            $('#talkbox').css('display', 'block');
            lid = $(this).attr("id");
            $('.windows_body').attr('lid', lid);
            user_title = $(this).attr('title');
            $(this).addClass('user_active');
            $(this).siblings().removeClass('user_active');
            $('#' + lid).children('div').eq(0).css('display', 'none');
            msg_nums[lid] = 0;
            $('#chatbox').html('');
            b();
            //获取聊天记录
            $.get('/get_chat_records?user_id=' + user_id + '&lid=' + lid, function (data) {
                console.log(data)
                $('.windows_top_box .user_title').html(user_title);
                $.each(data, function (k, v) {
                    if (v.send_user_id == $('#user_id').val()) {
                        u = 'me'
                    } else {
                        u = 'other'
                    }
                    img_addr = pic_addr + v.userinfo.pic_name;
                    if (v.content_type == 1) {
                        var info = '<li class=' + u + ' utype=' + v.content_type + ' ><img src="' + img_addr + '" title="' + v.userinfo.user_nick_name + '"><span>' + v.content + '</span></li>'
                    } else if (v.content_type == 2) {
                        info = '<li class=' + u + ' utype=' + v.content_type + ' ><img  src="' + img_addr + '" title="' + v.userinfo.user_nick_name + '"><img class="send_msg" src="' + v.content + '" /></li>'
                    } else {
                        file_name = v.file_info.file_name;
                        str_file_ext = v.file_info.file_ext;
                        //显示文件大小
                        filesize = get_file_size(v.file_info.file_size);
                        file_path = v.file_info.file_path + file_name;
                        file_show(u, img_addr, file_name, str_file_ext, 2, filesize,file_path, v.content_type);
                    }
                    $('#chatbox').append(info)
                    scroll_to_bottom()
                })
            }, 'json')
        });

        arr_images = ['png', 'jpg', 'jpeg', 'jpeg', 'gif'];
        file_exts = ['avi', 'css', 'docx', 'html', 'ini', 'mp3', 'pptx', 'rar', 'xls', 'xlxs', 'pdf', 'ppt', 'txt', 'zip'];//文件后缀
        file_ext = true;
        chat = $('#chatbox');

        function get_file_size(filesize) {
            if (filesize < 1024) {
                filesize = filesize + 'B';
            } else if (filesize < (1024 * 1024)) {
                filesize = (filesize / 1024).toFixed(2) + 'K';
            } else if (filesize < (1024 * 1024 * 1024)) {
                filesize = (filesize / 1024 / 1024).toFixed(2) + 'M';
            } else {
                filesize = (filesize / 1024 / 1024 / 1024).toFixed(2) + 'G';
            }
            return filesize;
        }

        // 文件展示
        function file_show(obj, img_addr, file_name, str_file_ext, is_process, file_size = 0,file_path, content_type) {
            chat.append('<li class=' + obj + ' utype=' + content_type + ' ><img src="' + img_addr + '"><i></i></li>');
            $("#chatbox li").last().children('i').load('/static/view/processBar.html', function () {
                is_in = jQuery.inArray(str_file_ext, file_exts);
                if (is_in == -1) {
                    file_icon = 'c.png'
                } else {
                    file_icon = str_file_ext + '.png'
                }
                $(' .left_text').last().children('k').html(file_name);
                $('.file_frame .right_file').last().children('img').attr('src', '/static/images/file_icon/' + file_icon);
                $('.bottom_down a').attr('href',file_path);
                //filename = file.name;
                if (is_process == 1) {
                    $('#progress').show();
                    $('.progress-bar').css('width', '0%');
                    $('.progress-bar').text('0%');
                    $('.progress-bar').removeClass('progress-bar-danger progress-bar-success');

                } else {
                    $('.middle_text').last().html(file_size)
                }
                //让滚动条到最底部
                scroll_to_bottom()
            });
        }

         // 发送文件时的消息格式
        function file_format(obj_file) {
            //最后一个聊天对象
            var chat_obj = $('#chatbox li').last();
            var content = {
                'lid':$('.windows_body').attr('lid'),
                'send_user_id':$('#user_id').val(),
                'recv_user_id':chat_obj.attr('xt'),
                'file_name' :obj_file.name,
                'file_path':'/static/upload/'+now_time+'/',
                'msg_type':chat_obj.attr('utype'),
                'file_size':obj_file.size
            };
            return content;
        }

        var j = 0;
        var task_id = WebUploader.Base.guid(); // 产生文件唯一标识符task_id
        function b() {
            if (boo) {
                uploader = WebUploader.create({
                    swf: './static/webuploader/Uploader.swf',
                    server: '/file/upload/' + now_time, // 上传分片地址
                    pick: '#picker',
                    auto: true,
                    chunked: true,
                    chunkSize: 20 * 1024 * 1024,
                    chunkRetry: 3,
                    threads: 1,
                    duplicate: true,
                    formData: { // 上传分片的http请求中一同携带的数据
                        task_id: task_id,
                    },
                });

                uploader.on('fileQueued', function (file) {
                    file_ext = jQuery.inArray(file.ext, arr_images);
                    if (file_ext != -1) {	//如果是图片
                        file_ext = false;
                    } else {
                        file_ext = true;
                    }
                    //如果上传的不是图片,是文件
                    if (file_ext) {
                        var obj = "me";
                        var img_addr = pic_addr + "{{data[0].pic_name}}";
                        //获取文件名
                        var file_name = file.name;
                        var str_file_ext = file.ext;
                        //展示文件
                        file_show(obj, img_addr, file_name, str_file_ext, 1, 0, 3)
                    }
                });
                uploader.on('startUpload', function () { // 开始上传时，调用该方法

                });

                uploader.on('uploadProgress', function (file, percentage) { // 一个分片上传成功后，调用该方法
                    $('.progress-bar').css('width', percentage * 100 - 1 + '%');
                    //$('.progress-bar').text(Math.floor(percentage * 100 - 1) + '%');
                });

                uploader.on('uploadSuccess', function (file) { // 整个文件的所有分片都上传成功后，调用该方法

                    var data = {'task_id': task_id, 'filename': file.name, 'now_time': now_time};
                    $.get('/file/merge', data, function () {
                        if (file_ext) {

                        }
                    }, 'json');
                    if (file_ext) {
                        $('.progress-bar').css('width', '100%');
                        $('.progress-bar').text('100%');
                        $('.progress-bar').addClass('progress-bar-success');
                        $('.progress-bar').text('上传成功');
                        //关闭进度条
                        $('#progress').remove();
                        //显示文件大小
                        filesize = get_file_size(file.size);
                        $(' .middle_text').last().html(filesize);
                        //发送文件
                        var content = file_format(file);
                        console.log(content)
                        socket.emit('imessage', content);
                    } else {
                        file_info = file.source.source;
                        var reader = new FileReader();
                        //将文件以Data URL形式读入页面
                        reader.readAsDataURL(file_info);
                        reader.onload = function (e) {
                            $('#chatbox').append(
                                '<li class="me" utype="' + 2 + '"><img src="' +
                                '/static/images/head/{{data[0].pic_name}}">' +
                                '<img class="send_msg" src="' + this.result + '" />' + '</li>'
                            );
                            //让滚动条到最底部
                            chat = $('#chatbox');
                            scrollTop = chat[0].scrollHeight;
                            chat.parent().scrollTop(scrollTop);

                            //发送文件
                            //用户id
                            var user_id = $('#user_id').val();
                            var lid = $('.user_active').attr('id')
                            var content = {
                                'lid': lid,
                                'send_user_id':user_id,
                                'send_msg': this.result,
                                'msg_type':2
                            }
                            socket.emit('imessage', content);
                        }
                    }

                });




                uploader.on('uploadError', function (file) { // 上传过程中发生异常，调用该方法
                    $('.progress-bar').css('width', '100%');
                    $('.progress-bar').text('100%');
                    $('.progress-bar').addClass('progress-bar-danger');
                    $('.progress-bar').text('上传失败');
                });

                uploader.on('uploadComplete', function (file) { // 上传结束，无论文件最终是否上传成功，该方法都会被调用
                    $('.progress-bar').removeClass('active progress-bar-striped');
                });
                boo = false
            }
        }

        $('#progress').hide();
        //发送消息
        $('#send').click(function () {
            msg = $(this).prev('div');
            if (msg.html() == '') {
                layer.msg('消息不能为空');
            } else {
                //用户id
                var user_id = $('#user_id').val();
                //用户易号
                var user_no = $('#user_no').val();
                var pic_name = "{{data[0].pic_name}}";
                var user_nick_name = "{{data[0].user_nick_name}}";
                lid = $('.user_active').attr('id')
                chat = $('#chatbox');
                talk = $('#talkbox');
                content = {
                    'lid': lid,
                    'send_user_id':user_id,
                    'send_msg': msg.html(),
                    'msg_type': 1
                }
                socket.emit('imessage', content);
                content['pic_name'] = pic_name;
                create_chart('me', content);
                msg.html('');
                scrollTop = chat[0].scrollHeight;
                chat.parent().scrollTop(scrollTop);
            }
        });

        function a() {
            var si1 = document.getElementById('si_1');
            var si2 = document.getElementById('si_2');
            var si3 = document.getElementById('si_3');
            si1.onclick = function () {
                si1.style.background = "url(/static/images/icon/head_2_1.png) no-repeat";
                si2.style.background = "";
                si3.style.background = "";
                $('.obj_list').css('display', 'none')
            };
            si2.onclick = function () {
                si2.style.background = "url(/static/images/icon/head_3_1.png) no-repeat";
                si1.style.background = "";
                si3.style.background = "";
                close_talk();
            };
            si3.onclick = function () {
                si3.style.background = "url(/static/images/icon/head_4_1.png) no-repeat";
                si1.style.background = "";
                si2.style.background = "";
                close_talk();
                $('.obj_list').css('display', 'none')
            };
        };
        a();
        //图片放大
        $('#chatbox').on('click', '.send_msg', function () {
            j = 0;
            var this_ = $(this);
            images = $('#chatbox').find('.send_msg');
            var imagesArr = new Array();
            $.each(images, function (i, image) {
                j = j + 1;
                imagesArr.push($(image).attr('src'));
                $(image).attr('id', j);
            });
            $.pictureViewer({
                images: imagesArr, //需要查看的图片，数据类型为数组
                initImageIndex: this_.attr('id'), //初始查看第几张图片，默认0
                scrollSwitch: true //是否使用鼠标滚轮切换图片，默认false
            });
        });


    }
</script>
</body>
</html>
